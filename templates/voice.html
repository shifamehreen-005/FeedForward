<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FeedForward - Page Title</title>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="{{ url_for('static', filename='normalize.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='webflow.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='fnus-stellar-site.webflow.css') }}"> 
  <link rel="stylesheet" href="{{ url_for('static', filename='chatbot.css') }}">  

  <!-- <link href="css/webflow.css" rel="stylesheet" />
  <link href="css/chatbot.css" rel="stylesheet" />
  <link href="css/explore.css" rel="stylesheet" />
  <link href="css/fnus-stellar-site.webflow.css" rel="stylesheet" /> -->

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ["Mona Sans:200,300,regular,500,600,700,800,900", "Old Standard TT:regular"]
      }
    });
  </script>

  <!-- Favicons -->
  <link href="static/favicon.png" rel="shortcut icon" type="image/x-icon" />
  <link href="images/webclip.png" rel="apple-touch-icon" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .visualizer {
      width: 100%;
      height: 150px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .form-container {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-height: 500px; /* Set a fixed height */
      overflow-y: auto; /* Enable vertical scrolling */
      scroll-behavior: smooth; /* Add smooth scrolling */
      position: relative; /* For positioning the success image */

    }
    
    .form-question {
      margin-bottom: 15px;
      padding: 10px;
      border-left: 3px solid #007bff;
      display: none;
    }
    
    .form-question.active {
      display: block;
      background-color: #e7f5ff;
    }
    
    .form-question.completed {
      display: block;
      border-left: 3px solid #28a745;
    }
    
    .form-controls {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    
    .progress {
      height: 8px;
      margin-bottom: 15px;
    }
    
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .completion-image {
    display: none; /* Hidden by default */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f8f9fa;
    border-radius: 10px;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-align: center;
  }

  .completion-image img {
    max-width: 80%;
    max-height: 300px;
    margin-bottom: 20px;
  }

  .completion-image h3 {
    margin-top: 20px;
    color: #28a745;
  }
  </style>
</head>

<body >
  <!-- Navigation Bar Component -->
  <special-header></special-header>
  <script src="{{ url_for('static', filename='navfootermanager.js') }}"></script>


  <!-- Page content starts here -->
  <div class="container">
    <h1 class="mb-4">Food Bank Assistant</h1>
    <div id="chat-container">
      <div class="language-toggle">
        <input type="checkbox" id="lang-switch" />
        <label for="lang-switch" class="toggle-label">
          <span class="lang-text en">EN</span>
          <span class="slider"></span>
          <span class="lang-text es">ES</span>
        </label>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="mb-3">
          <p><strong>User Voice:</strong></p>
          <canvas id="localVisualizer" class="visualizer"></canvas>
        </div>
        <div class="mb-3">
          <p><strong>Agent Voice:</strong></p>
          <canvas id="backendVisualizer" class="visualizer"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-container">
          <h3>Food Bank Assistance Form</h3>
          <p class="text-muted">Our voice assistant will guide you through these questions to help find the right food bank services for your needs.</p>
          
          <div class="progress">
            <div id="formProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          
          <div id="formQuestions">
            <div class="form-question" data-question-id="1">
              <label class="form-label">What is your name?</label>
              <input type="text" class="form-control" id="name" placeholder="Your name">
            </div>
            
            <div class="form-question" data-question-id="2">
              <label class="form-label">Do you have access to a kitchen?</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="kitchen-access" id="kitchen-yes" value="Yes">
                <label class="form-check-label" for="kitchen-yes">Yes</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="kitchen-access" id="kitchen-no" value="No">
                <label class="form-check-label" for="kitchen-no">No</label>
              </div>
            </div>
            
            <div class="form-question" data-question-id="3">
              <label class="form-label">How would you like your food?</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="food-loose" value="Loose groceries">
                <label class="form-check-label" for="food-loose">Loose groceries</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="food-packaged" value="Pre-bagged or boxed groceries">
                <label class="form-check-label" for="food-packaged">Pre-bagged or boxed groceries</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="food-prepared" value="Prepared meals">
                <label class="form-check-label" for="food-prepared">Prepared meals</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="food-any" value="Any">
                <label class="form-check-label" for="food-any">Any</label>
              </div>
            </div>
            
            <div class="form-question" data-question-id="4">
              <label class="form-label">Do you have any dietary preferences?</label>
              <div class="checkbox-group">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-latin" value="Latin American">
                  <label class="form-check-label" for="pref-latin">Latin American</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-westafrican" value="West African">
                  <label class="form-check-label" for="pref-westafrican">West African</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-eastafrican" value="East African">
                  <label class="form-check-label" for="pref-eastafrican">East African</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-southasian" value="Central/South Asian">
                  <label class="form-check-label" for="pref-southasian">Central/South Asian</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-eastasian" value="East Asian">
                  <label class="form-check-label" for="pref-eastasian">East Asian</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-easteuropean" value="Eastern European">
                  <label class="form-check-label" for="pref-easteuropean">Eastern European</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-middleeastern" value="Middle Eastern/North African">
                  <label class="form-check-label" for="pref-middleeastern">Middle Eastern/North African</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-halal" value="Halal">
                  <label class="form-check-label" for="pref-halal">Halal</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-kosher" value="Kosher">
                  <label class="form-check-label" for="pref-kosher">Kosher</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-vegetarian" value="Vegetarian">
                  <label class="form-check-label" for="pref-vegetarian">Vegetarian</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-vegan" value="Vegan">
                  <label class="form-check-label" for="pref-vegan">Vegan</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pref-none" value="None">
                  <label class="form-check-label" for="pref-none">None</label>
                </div>
              </div>
            </div>
            
            <div class="form-question" data-question-id="5">
              <label class="form-label">Are you able to travel to pick up food?</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="travel-ability" id="travel-yes" value="Yes">
                <label class="form-check-label" for="travel-yes">Yes</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="travel-ability" id="travel-no" value="No">
                <label class="form-check-label" for="travel-no">No</label>
              </div>
            </div>
            
            <div class="form-question" data-question-id="6">
              <label class="form-label">Can someone else pick up food for you?</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="someone-else" id="someone-yes" value="Yes">
                <label class="form-check-label" for="someone-yes">Yes</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="someone-else" id="someone-no" value="No">
                <label class="form-check-label" for="someone-no">No</label>
              </div>
            </div>
            
            <div class="form-question" data-question-id="7">
              <label class="form-label">When would you like to go?</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="day-preference" id="day-today" value="Today">
                <label class="form-check-label" for="day-today">Today</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="day-preference" id="day-another" value="Another day">
                <label class="form-check-label" for="day-another">Another day</label>
              </div>
            </div>
            
            <div class="form-question" data-question-id="8">
              <label class="form-label">Which day would you prefer?</label>
              <div class="checkbox-group">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-tomorrow" value="Tomorrow">
                  <label class="form-check-label" for="day-tomorrow">Tomorrow</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-monday" value="Monday">
                  <label class="form-check-label" for="day-monday">Monday</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-tuesday" value="Tuesday">
                  <label class="form-check-label" for="day-tuesday">Tuesday</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-wednesday" value="Wednesday">
                  <label class="form-check-label" for="day-wednesday">Wednesday</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-thursday" value="Thursday">
                  <label class="form-check-label" for="day-thursday">Thursday</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-friday" value="Friday">
                  <label class="form-check-label" for="day-friday">Friday</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-saturday" value="Saturday">
                  <label class="form-check-label" for="day-saturday">Saturday</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day-sunday" value="Sunday">
                  <label class="form-check-label" for="day-sunday">Sunday</label>
                </div>
              </div>
            </div>
            
            <div class="form-question" data-question-id="9">
              <label class="form-label">What time would you prefer?</label>
              <select class="form-select" id="preferred-time">
                <option value="">Select a time range</option>
                <option value="Morning (9am-12pm)">Morning (9am-12pm)</option>
                <option value="Afternoon (12pm-4pm)">Afternoon (12pm-4pm)</option>
                <option value="Evening (4pm-7pm)">Evening (4pm-7pm)</option>
              </select>
            </div>
            
            <div class="form-question" data-question-id="10">
              <label class="form-label">What is your location?</label>
              <input type="text" class="form-control" id="location" placeholder="Your address or neighborhood">
            </div>
            
            <div class="form-question" data-question-id="11">
              <label class="form-label">For home delivery, what time would you prefer?</label>
              <select class="form-select" id="delivery-time">
                <option value="">Select a time range</option>
                <option value="Morning (9am-12pm)">Morning (9am-12pm)</option>
                <option value="Afternoon (12pm-4pm)">Afternoon (12pm-4pm)</option>
                <option value="Evening (4pm-7pm)">Evening (4pm-7pm)</option>
              </select>
            </div>
            
            <div class="form-question" data-question-id="12">
              <label class="form-label">Any additional comments or needs?</label>
              <textarea class="form-control" id="comments" rows="3" placeholder="Please share any other information that might help us serve you better"></textarea>
            </div>
          </div>
          
          <div class="form-controls">
            <button type="button" id="startVoiceForm" class="btn btn-primary">Start Voice Form</button>
            <button type="button" id="resetForm" class="btn btn-secondary">Reset Form</button>
          </div>

          <div class="completion-image">
            <h3>Form Complete!</h3>
            <img src="/api/placeholder/400/300" alt="Food bank services available">
            <p class="lead">Thank you for completing the form. We've found food bank services that match your preferences.</p>
            <p>Transit options are being calculated to help you reach your nearest food bank.</p>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="{{ url_for('static', filename='webflow.js') }}"></script>
<script>
      document.getElementById('close-chatbot').addEventListener('click', function () {
    // Go back to the previous page
    window.history.back();
  });
</script>

</body>
</html>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

  let globalFoodBanks = [{"Agency ID":"14222-PART-01","Agency Name":"SevaTruck Foundation : SevaTruck Foundation","Agency Region":"VA","County\/Ward":"VA Fairfax County","Shipping Address":"Attn: SevaTruck Foundation 2815 Old Lee Hwy Fairfax Fairfax VA 22031","Cleaned Address":"2815 Old Lee Hwy Fairfax Fairfax VA 22031","Latitude":38.8757888053,"Longitude":-77.2392202721,"Phone":"(202) 550-3018","Day of Week":"Wednesday","Frequency":"Every week","Starting Time":"15:00:00","Ending Time":"17:00:00","By Appointment Only":"Yes","Food Pantry Requirements":null,"Food Format":"Prepared meals","Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"Yes","Distribution Models":"Walk up","Cultural Populations Served":"Central\/South Asian,East Asian,Latin American","Latin American":"Yes","West African":"No","East African":"No","Central\/South Asian":"Yes","East Asian":"Yes","Eastern European":"No","Middle Eastern\/North African":"No","Last SO Create Date":"2025-02-19","Date of Last Verification":"2025-01-16","Additional Note on Hours of Operations":"Braddock ES-7825 Heritage Dr, Annandale, VA 22003"},
{"Agency ID":"14240-PART-01","Agency Name":"Interfaith Community Action Council : Interfaith Community Action Council - Oxon Hill Food Pantry","Agency Region":"MD","County\/Ward":"MD Prince George's County","Shipping Address":"Attn: Oxon Hill Food Pantry 4915 Saint Barnabas Road Temple Hills MD 20748","Cleaned Address":"4915 Saint Barnabas Road Temple Hills MD 20748","Latitude":38.8219741,"Longitude":-76.9565648858,"Phone":"(301) 899-8358","Day of Week":"Saturday","Frequency":"2nd of the Month","Starting Time":"10:00:00","Ending Time":"12:00:00","By Appointment Only":"Yes","Food Pantry Requirements":"Zip Code","Food Format":"Loose groceries","Loose groceries":"Yes","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":"Drive thru,Walk up","Cultural Populations Served":"East African,East Asian,Latin American,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"No","East Asian":"Yes","Eastern European":"No","Middle Eastern\/North African":"No","Last SO Create Date":"2025-02-15","Date of Last Verification":"2024-10-02","Additional Note on Hours of Operations":null},
{"Agency ID":"14265-PART-01","Agency Name":"St. Martins Social Service : St. Martins Social Service","Agency Region":"DC","County\/Ward":"DC Ward 5","Shipping Address":"Attn: St. Martin's Social Service 1908 North Capitol Street NW Washington DC 20002","Cleaned Address":"1908 North Capitol Street NW Washington DC 20002","Latitude":38.9157583,"Longitude":-77.0095096768,"Phone":"(202) 232-1144","Day of Week":"Wednesday","Frequency":"Every week","Starting Time":"10:00:00","Ending Time":"11:30:00","By Appointment Only":"No","Food Pantry Requirements":null,"Food Format":null,"Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":null,"Cultural Populations Served":null,"Latin American":null,"West African":null,"East African":null,"Central\/South Asian":null,"East Asian":null,"Eastern European":null,"Middle Eastern\/North African":null,"Last SO Create Date":"2025-01-03","Date of Last Verification":"2024-10-07","Additional Note on Hours of Operations":"walkups"},
{"Agency ID":"14305-PART-01","Agency Name":"THRIVE DC : Thrive DC","Agency Region":"DC","County\/Ward":"DC Ward 1","Shipping Address":"Attn: THRIVE DC 1525 Newton Street NW Washington DC 20010","Cleaned Address":"1525 Newton Street NW Washington DC 20010","Latitude":38.933592,"Longitude":-77.0355665,"Phone":"(202) 737-9311","Day of Week":"Thursday","Frequency":"Every week","Starting Time":"10:00:00","Ending Time":"12:00:00","By Appointment Only":"No","Food Pantry Requirements":"ID,Income,Zip Code","Food Format":null,"Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":null,"Cultural Populations Served":"Central\/South Asian,East Asian,Latin American,Middle Eastern\/ North African,West African","Latin American":"Yes","West African":"Yes","East African":"No","Central\/South Asian":"Yes","East Asian":"Yes","Eastern European":"No","Middle Eastern\/North African":"Yes","Last SO Create Date":"2025-02-07","Date of Last Verification":"2024-10-09","Additional Note on Hours of Operations":null},
{"Agency ID":"14355-PART-01","Agency Name":"Family & Medical Counseling Service : Family & Medical Counseling Service","Agency Region":"DC","County\/Ward":"DC Ward 8","Shipping Address":"Attn: Family & Medical Counseling Service 2041 MLK Jr. Ave. SE Suite 303 Washington DC 20020","Cleaned Address":"2041 MLK Jr. Ave. SE Suite 303 Washington DC 20020","Latitude":38.8659889,"Longitude":-76.9897972,"Phone":"(202) 889-7900","Day of Week":"Friday","Frequency":"1st and 3rd of the Month","Starting Time":"10:00:00","Ending Time":"13:00:00","By Appointment Only":"Yes","Food Pantry Requirements":"ID,Zip Code","Food Format":"Pre-bagged or boxed groceries","Loose groceries":"No","Pre-bagged or boxed groceries":"Yes","Prepared meals":"No","Distribution Models":null,"Cultural Populations Served":"East African,Latin American,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"No","East Asian":"No","Eastern European":"No","Middle Eastern\/North African":"No","Last SO Create Date":"2025-02-05","Date of Last Verification":"2024-09-25","Additional Note on Hours of Operations":null},
{"Agency ID":"14375-PART-01","Agency Name":"Agape Early Childhood Learning : Agape Early Childhood Learning","Agency Region":"MD","County\/Ward":"MD Prince George's County","Shipping Address":"Attn: Agape Early Childhood Learning 4318 Rhode Island Avenue Brentwood MD 20722","Cleaned Address":"4318 Rhode Island Avenue Brentwood MD 20722","Latitude":38.9409284088,"Longitude":-76.9527761367,"Phone":"(301) 927-4674","Day of Week":"Wednesday","Frequency":"4th of the Month","Starting Time":"15:00:00","Ending Time":"17:30:00","By Appointment Only":"Yes","Food Pantry Requirements":null,"Food Format":"Pre-bagged or boxed groceries","Loose groceries":"No","Pre-bagged or boxed groceries":"Yes","Prepared meals":"No","Distribution Models":"Walk up","Cultural Populations Served":"Central\/South Asian,East African,Latin American,Middle Eastern\/ North African,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"Yes","East Asian":"No","Eastern European":"No","Middle Eastern\/North African":"Yes","Last SO Create Date":"2024-10-21","Date of Last Verification":"2024-10-11","Additional Note on Hours of Operations":"Appointments open to parents, staff, and referred families"},
{"Agency ID":"14410-PART-01","Agency Name":"Spanish Catholic Center : Spanish Catholic Center","Agency Region":"DC","County\/Ward":"DC Ward 1","Shipping Address":"Attn: Spanish Catholic Center 1618 Monroe St. NW Washington DC 20010","Cleaned Address":"1618 Monroe St. NW Washington DC 20010","Latitude":38.93271405,"Longitude":-77.0373982767,"Phone":null,"Day of Week":"Wednesday","Frequency":"Every week","Starting Time":"10:00:00","Ending Time":"16:00:00","By Appointment Only":"No","Food Pantry Requirements":"Zip Code","Food Format":"Loose groceries","Loose groceries":"Yes","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":"Walk up","Cultural Populations Served":"Central\/South Asian,East African,East Asian,Latin American,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"Yes","East Asian":"Yes","Eastern European":"No","Middle Eastern\/North African":"No","Last SO Create Date":"2024-08-08","Date of Last Verification":"2024-12-16","Additional Note on Hours of Operations":null},
{"Agency ID":"14500-PART-01","Agency Name":"Central Union Mission : Central Union Mission","Agency Region":"DC","County\/Ward":"DC Ward 6","Shipping Address":"Attn: Central Union Mission 65 Massachusetts Ave Washington DC 20001","Cleaned Address":"65 Massachusetts Ave Washington DC 20001","Latitude":38.89868405,"Longitude":-77.0110822499,"Phone":"(202) 718-0549","Day of Week":"Monday","Frequency":"Every week","Starting Time":"12:30:00","Ending Time":"18:00:00","By Appointment Only":"No","Food Pantry Requirements":"Zip Code","Food Format":"Prepared meals","Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"Yes","Distribution Models":"Walk up","Cultural Populations Served":"Latin American,Middle Eastern\/ North African,West African","Latin American":"Yes","West African":"Yes","East African":"No","Central\/South Asian":"No","East Asian":"No","Eastern European":"No","Middle Eastern\/North African":"Yes","Last SO Create Date":"2025-02-24","Date of Last Verification":"2024-10-04","Additional Note on Hours of Operations":"We serve Breakfast -Lunch-Dinner"},
{"Agency ID":"14520-PART-01","Agency Name":"Father Mckenna Center : The Father McKenna Center","Agency Region":"DC","County\/Ward":"DC Ward 6","Shipping Address":"Attn: The Father McKenna Center 900 North Capital St NW Washington DC DC 20002","Cleaned Address":"900 North Capital St NW Washington DC DC 20002","Latitude":38.9014721,"Longitude":-77.0093608,"Phone":"(202) 842-1112","Day of Week":"Friday","Frequency":"Every week","Starting Time":"13:30:00","Ending Time":"14:30:00","By Appointment Only":"No","Food Pantry Requirements":"ID,Income","Food Format":"Loose groceries","Loose groceries":"Yes","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":"Walk up","Cultural Populations Served":"Central\/South Asian,East African,East Asian,Eastern European,Latin American,Middle Eastern\/ North African,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"Yes","East Asian":"Yes","Eastern European":"Yes","Middle Eastern\/North African":"Yes","Last SO Create Date":"2025-02-26","Date of Last Verification":"2024-09-23","Additional Note on Hours of Operations":"To use our full pantry, we require that in an addition to a photo ID that our visitors provide us with a copy of a proof of residence in DC. This can be a current lease, or a recent utility bill, rent receipt, mortgage, or deed."},
{"Agency ID":"14540-PART-01","Agency Name":"Miriam's Kitchen : Miriam's Kitchen","Agency Region":"DC","County\/Ward":"DC Ward 2","Shipping Address":"Attn: Miriam's Kitchen 2401 Virginia Ave NW Washington DC 20037","Cleaned Address":"2401 Virginia Ave NW Washington DC 20037","Latitude":38.898593,"Longitude":-77.0516915247,"Phone":"(240) 350-1058","Day of Week":"Friday","Frequency":"Every week","Starting Time":"07:00:00","Ending Time":"08:00:00","By Appointment Only":"No","Food Pantry Requirements":null,"Food Format":"Prepared meals","Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"Yes","Distribution Models":"Walk up","Cultural Populations Served":"Central\/South Asian,East African,East Asian,Eastern European,Latin American,Middle Eastern\/ North African,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"Yes","East Asian":"Yes","Eastern European":"Yes","Middle Eastern\/North African":"Yes","Last SO Create Date":"2025-02-24","Date of Last Verification":"2024-11-12","Additional Note on Hours of Operations":null},
{"Agency ID":"14545-PART-01","Agency Name":"Mt. Rainier Seventh Day Adventist Spanish Church : Mount Rainier Seventh Day Adventist Spanish Church","Agency Region":"MD","County\/Ward":"MD Prince George's County","Shipping Address":"Attn: Mount Rainier Seventh Day Adventist Spanish Chuch 6012 Ager Road Hyattsville MD 20782","Cleaned Address":"6012 Ager Road Hyattsville MD 20782","Latitude":38.9542534204,"Longitude":-76.9652870101,"Phone":"(240) 346-9272","Day of Week":"Wednesday","Frequency":"2nd of the Month","Starting Time":"19:00:00","Ending Time":"21:00:00","By Appointment Only":"Yes","Food Pantry Requirements":"ID","Food Format":"Loose groceries","Loose groceries":"Yes","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":"Drive thru,Home Delivery,Walk up","Cultural Populations Served":"East African,Eastern European,Latin American,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"No","East Asian":"No","Eastern European":"Yes","Middle Eastern\/North African":"No","Last SO Create Date":"2024-12-02","Date of Last Verification":"2024-10-09","Additional Note on Hours of Operations":null},
{"Agency ID":"14570-PART-01","Agency Name":"ALIVE : ALIVE","Agency Region":"VA","County\/Ward":"VA City of Alexandria","Shipping Address":"Attn: ALIVE 801 S Payne St Alexandria VA 22302","Cleaned Address":"801 S Payne St Alexandria VA 22302","Latitude":38.7977023,"Longitude":-77.0560352676,"Phone":"(703) 837-9300","Day of Week":"Saturday","Frequency":"4th of the Month","Starting Time":"08:30:00","Ending Time":"10:30:00","By Appointment Only":"No","Food Pantry Requirements":null,"Food Format":null,"Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":null,"Cultural Populations Served":"Central\/South Asian,East African,Eastern European,Latin American,Middle Eastern\/ North African","Latin American":"Yes","West African":"No","East African":"Yes","Central\/South Asian":"Yes","East Asian":"No","Eastern European":"Yes","Middle Eastern\/North African":"Yes","Last SO Create Date":"2025-02-11","Date of Last Verification":"2024-09-26","Additional Note on Hours of Operations":"Last Saturday of the month, not necessarily the 4th Saturday"},
{"Agency ID":"14570-PUSH-06","Agency Name":"William Ramsay Recreation Center","Agency Region":"Virginia","County\/Ward":"City of Alexandria","Shipping Address":"Del Pepper Community Center 4850 Mark Center Dr Alexandria VA 22311","Cleaned Address":"4850 Mark Center Dr Alexandria VA 22311","Latitude":38.8299343,"Longitude":-77.1191301359,"Phone":null,"Day of Week":"Saturday","Frequency":"4th of the Month","Starting Time":"08:30:00","Ending Time":"10:30:00","By Appointment Only":null,"Food Pantry Requirements":null,"Food Format":null,"Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":null,"Cultural Populations Served":null,"Latin American":null,"West African":null,"East African":null,"Central\/South Asian":null,"East Asian":null,"Eastern European":null,"Middle Eastern\/North African":null,"Last SO Create Date":null,"Date of Last Verification":null,"Additional Note on Hours of Operations":null},
{"Agency ID":"14570-PUSH-07","Agency Name":"Chick Armstrong Recreation Center","Agency Region":"Virginia","County\/Ward":"City of Alexandria","Shipping Address":"ALIVE Chick Armstrong Rec Center 25 W Reed Ave Alexandria VA 22305","Cleaned Address":"25 W Reed Ave Alexandria VA 22305","Latitude":38.83723415,"Longitude":-77.0580736048,"Phone":null,"Day of Week":"Saturday","Frequency":"4th of the Month","Starting Time":"08:30:00","Ending Time":"10:30:00","By Appointment Only":null,"Food Pantry Requirements":null,"Food Format":null,"Loose groceries":"No","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":null,"Cultural Populations Served":null,"Latin American":null,"West African":null,"East African":null,"Central\/South Asian":null,"East Asian":null,"Eastern European":null,"Middle Eastern\/North African":null,"Last SO Create Date":null,"Date of Last Verification":null,"Additional Note on Hours of Operations":null}];

  async function loadFoodBankData() {
  try {
    const response = await fetch('/static/cafb_db.json');
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    
    const foodBanks = await response.json();
    console.log(`Loaded ${foodBanks.length} food bank records`);
    return foodBanks;
  } catch (error) {
    console.error("Error loading food bank data:", error);
    // Return fallback data in case of error
    return defaultFoodBanks;
  }
  }

  function normalizeFormData(formData) {
    const updatedForm = {...formData};
    
    // Normalize food_format
    if (updatedForm.foodFormat && updatedForm.foodFormat.includes("Any")) {
      updatedForm.foodFormat = [
        "Loose groceries",
        "Pre-bagged or boxed groceries",
        "Prepared meals"
      ];
    }
    
    // Normalize dietary_pref
    const cultureMap = {
      "Halal": ["Middle Eastern/North African"],
      "Kosher": ["Eastern European", "Middle Eastern/North African"],
      "Vegetarian": ["Central/South Asian", "East Asian"],
      "Vegan": ["Central/South Asian", "East Asian"]
    };
    
    if (updatedForm.dietaryPreferences) {
      let expanded = [];
      if (updatedForm.dietaryPreferences.includes("None")) {
        expanded = [
          "Latin American", "West African", "East African",
          "Central/South Asian", "East Asian", "Eastern European", "Middle Eastern/North African"
        ];
      } else {
        updatedForm.dietaryPreferences.forEach(item => {
          if (cultureMap[item]) {
            expanded.push(...cultureMap[item]);
          } else {
            expanded.push(item);
          }
        });
      }
      
      // Remove duplicates
      updatedForm.dietaryPreferences = [...new Set(expanded)];
    }
    
    return updatedForm;
  }
  

  function getSelectedCheckboxValues(idArray) {
    return idArray
      .filter(id => document.getElementById(id)?.checked)
      .map(id => document.getElementById(id).value);
  }
  
  function shouldShowQuestion(questionId) {
    switch(questionId) {
      case "3": // Food format question
        return document.getElementById("kitchen-yes")?.checked || false;
        
      case "6": // Someone else can pick up
        return document.getElementById("travel-no")?.checked || false;
        
      case "7": // Day preference
        return document.getElementById("travel-yes")?.checked || 
               document.getElementById("someone-yes")?.checked || false;
        
      case "8": // Specific day
        return document.getElementById("day-another")?.checked || false;
        
      case "9": // Preferred time
      case "10": // Location for pickup
        return document.getElementById("travel-yes")?.checked || 
               document.getElementById("someone-yes")?.checked || false;
        
      case "11": // Delivery time
        return document.getElementById("travel-no")?.checked && 
               document.getElementById("someone-no")?.checked || false;
        
      default:
        return true;
    }
  }
  
  function generateFormSummary(formData) {
    let summary = [];
    
    if (formData.name) {
      summary.push(`Name: ${formData.name}`);
    }
    
    if (formData.hasKitchen) {
      summary.push("Has access to a kitchen");
    } else {
      summary.push("Does not have access to a kitchen");
    }
    
    if (formData.foodFormat && formData.foodFormat.length > 0) {
      summary.push(`Food format preference: ${formData.foodFormat.join(", ")}`);
    }
    
    if (formData.dietaryPreferences && formData.dietaryPreferences.length > 0 && !formData.dietaryPreferences.includes("None")) {
      summary.push(`Dietary preferences: ${formData.dietaryPreferences.join(", ")}`);
    }
    
    if (formData.canTravel) {
      summary.push("Can travel to pick up food");
      
      if (formData.dayPreference) {
        if (formData.dayPreference === "Today") {
          summary.push("Preferred pickup day: Today");
        } else if (formData.specificDays && formData.specificDays.length > 0) {
          summary.push(`Preferred pickup days: ${formData.specificDays.join(", ")}`);
        }
      }
      
      if (formData.preferredTime) {
        summary.push(`Preferred pickup time: ${formData.preferredTime}`);
      }
    } else if (formData.someoneElseCanPickup) {
      summary.push("Someone else can pick up food");
      
      if (formData.dayPreference) {
        if (formData.dayPreference === "Today") {
          summary.push("Preferred pickup day: Today");
        } else if (formData.specificDays && formData.specificDays.length > 0) {
          summary.push(`Preferred pickup days: ${formData.specificDays.join(", ")}`);
        }
      }
      
      if (formData.preferredTime) {
        summary.push(`Preferred pickup time: ${formData.preferredTime}`);
      }
    } else {
      summary.push("Needs home delivery");
      
      if (formData.deliveryTime) {
        summary.push(`Preferred delivery time: ${formData.deliveryTime}`);
      }
    }
    
    if (formData.location) {
      summary.push(`Location: ${formData.location}`);
    }
    
    if (formData.comments) {
      summary.push(`Additional comments: ${formData.comments}`);
    }
    
    return summary.join(". ");
  }
  
  const fns = {
    getPageHTML: () => {
      return { success: true, html: document.documentElement.outerHTML };
    },
    changeBackgroundColor: ({ color }) => {
      document.body.style.backgroundColor = color;
      return { success: true, color };
    },
    changeTextColor: ({ color }) => {
      document.body.style.color = color;
      return { success: true, color };
    },
    voiceTransit: async ({ location }) => {
      const formStatus = fns.getFormStatus();
      if (!formStatus.isCompleted) {
        return {
          success: false,
          message: "User has not filled all details in the form yet - get next question in the form, fill it and once complete come back again"
        };
      }

      try {
        if (!window.userLocation) {
          await getUserLocation();
          if (!window.userLocation) {
            throw new Error("Could not access your current location");
          }
        }
        const userLat = window.userLocation.latitude;
        const userLon = window.userLocation.longitude;
        const locationStr = `${userLat}, ${userLon}`;
        const nearestFoodBank = findNearestFoodBankVoice(locationStr);
        if (typeof nearestFoodBank === 'string') {
          return { success: false, error: nearestFoodBank };
        }
        const foodBankLat = nearestFoodBank.lat;
        const foodBankLon = nearestFoodBank.lon;
        const newInputStr = `${userLat}, ${userLon}, ${foodBankLat}, ${foodBankLon}`;
        const results = await planTransit(newInputStr);

        return {
        success: true,
        user_location: { latitude: userLat, longitude: userLon },
        nearest_food_bank: nearestFoodBank.name,
        food_bank_details: {
          address: nearestFoodBank.address,
          phone: nearestFoodBank.phone,
          food_format: nearestFoodBank.foodFormat,
          day_available: nearestFoodBank.dayOfWeek,
          hours: nearestFoodBank.hours,
          frequency: nearestFoodBank.frequency,
          appointment_required: nearestFoodBank.appointment,
          requirements: nearestFoodBank.requirements,
          offers_delivery: nearestFoodBank.offersDelivery
        },
        distance_km: haversineDistance(userLat, userLon, foodBankLat, foodBankLon).toFixed(2),
        transit_options: JSON.parse(results)
      };

      } catch (e) {
        return { success: false, error: `Error: ${e.toString()}` };
      }
    },
     
    
    processFormInput: ({ questionId, answer }) => {
      try {
 // First try to find the question by ID
 let questionElement = document.querySelector(`.form-question[data-question-id="${questionId}"]`);
  
  // If not found, try to infer the question ID from field names or labels
  if (!questionElement) {
    // Handle case where agent passes the field name instead of the question ID
    const nameToIdMap = {
      'name': '1',
      'kitchen': '2', 'kitchen access': '2',
      'food': '3', 'food format': '3',
      'dietary': '4', 'preferences': '4', 'dietary preferences': '4',
      'travel': '5', 'travel ability': '5',
      'someone': '6', 'someone else': '6',
      'day': '7', 'when': '7',
      'which day': '8', 'specific day': '8',
      'time': '9', 'preferred time': '9',
      'location': '10',
      'delivery': '11', 'delivery time': '11',
      'comments': '12'
    };
    
    // Try to look up the correct ID
    const correctedId = nameToIdMap[questionId.toLowerCase()];
    if (correctedId) {
      questionId = correctedId;
      questionElement = document.querySelector(`.form-question[data-question-id="${questionId}"]`);
    }
    
    // If still not found, try to find the active question
    if (!questionElement) {
      questionElement = document.querySelector('.form-question.active');
      if (questionElement) {
        questionId = questionElement.dataset.questionId;
        console.log(`Using active question with ID: ${questionId}`);
      }
    }
  }
  
  if (!questionElement) {
    return { success: false, error: "Question not found. Please try again with the correct question ID." };
  }
       
        // Process the answer based on question ID
        switch(questionId) {
          case "1": // Name
          const nameInput = document.getElementById("name");
          nameInput.value = answer;
          console.log(`Set name input value to: ${nameInput.value}`);
          break;
            
          case "2": // Kitchen access
          const kitchenAccess = answer.toLowerCase();
          const kitchenYes = document.getElementById("kitchen-yes");
          const kitchenNo = document.getElementById("kitchen-no");
          
          // Clear previous selection first
          kitchenYes.checked = false;
          kitchenNo.checked = false;
          
          // Set new selection with debug logs
          if (kitchenAccess.includes("yes")) {
            kitchenYes.checked = true;
            console.log("Set kitchen-yes to checked");
          } else if (kitchenAccess.includes("no")) {
            kitchenNo.checked = true;
            console.log("Set kitchen-no to checked");
          }
          
          // Manually trigger change event to ensure UI updates
          const changeEvent = new Event('change', { bubbles: true });
          kitchenYes.checked ? kitchenYes.dispatchEvent(changeEvent) : kitchenNo.dispatchEvent(changeEvent);
          break;
            
          case "3": // Food format
  // Food format
          const foodOptions = answer.toLowerCase().split(',').map(opt => opt.trim());
          const foodLoose = document.getElementById("food-loose");
          const foodPackaged = document.getElementById("food-packaged");
          const foodPrepared = document.getElementById("food-prepared");
          const foodAny = document.getElementById("food-any");
          
          // Clear previous selections
          foodLoose.checked = false;
          foodPackaged.checked = false;
          foodPrepared.checked = false;
          foodAny.checked = false;
          
          // Set new selections with debug logs
          if (foodOptions.some(opt => opt.includes("loose"))) {
            foodLoose.checked = true;
            console.log("Set food-loose to checked");
          }
          if (foodOptions.some(opt => opt.includes("bagged") || opt.includes("boxed"))) {
            foodPackaged.checked = true;
            console.log("Set food-packaged to checked");
          }
          if (foodOptions.some(opt => opt.includes("prepared") || opt.includes("meal"))) {
            foodPrepared.checked = true;
            console.log("Set food-prepared to checked");
          }
          if (foodOptions.some(opt => opt.includes("any"))) {
            foodAny.checked = true;
            console.log("Set food-any to checked");
          }
          
          // Trigger change events
          [foodLoose, foodPackaged, foodPrepared, foodAny].forEach(checkbox => {
            if (checkbox.checked) {
              checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
          break;
            
// Continuing from the previous case statements...

        case "4": // Dietary preferences
          const dietaryPrefs = answer.toLowerCase().split(',').map(pref => pref.trim());
          
          // Clear all previous dietary preference selections
          const dietaryCheckboxes = [
            "pref-latin", "pref-westafrican", "pref-eastafrican", "pref-southasian",
            "pref-eastasian", "pref-easteuropean", "pref-middleeastern", "pref-halal",
            "pref-kosher", "pref-vegetarian", "pref-vegan", "pref-none"
          ];
          
          // Uncheck all first
          dietaryCheckboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
              checkbox.checked = false;
            }
          });
          
          // Then check the ones mentioned in answer
          const dietaryKeywords = {
            "latin": "pref-latin",
            "west african": "pref-westafrican", 
            "east african": "pref-eastafrican",
            "central asian": "pref-southasian", "south asian": "pref-southasian",
            "east asian": "pref-eastasian",
            "eastern european": "pref-easteuropean",
            "middle eastern": "pref-middleeastern", "north african": "pref-middleeastern",
            "halal": "pref-halal",
            "kosher": "pref-kosher",
            "vegetarian": "pref-vegetarian",
            "vegan": "pref-vegan",
            "none": "pref-none"
          };
          
          // Check matching preferences
          dietaryPrefs.forEach(pref => {
            for (const [keyword, id] of Object.entries(dietaryKeywords)) {
              if (pref.includes(keyword)) {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                  checkbox.checked = true;
                  checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                  console.log(`Set ${id} to checked`);
                }
              }
            }
          });
          break;

        case "5": // Travel ability
          const canTravel = answer.toLowerCase();
          const travelYes = document.getElementById("travel-yes");
          const travelNo = document.getElementById("travel-no");
          
          // Clear previous selection first
          travelYes.checked = false;
          travelNo.checked = false;
          
          // Set new selection
          if (canTravel.includes("yes")) {
            travelYes.checked = true;
            console.log("Set travel-yes to checked");
          } else if (canTravel.includes("no")) {
            travelNo.checked = true;
            console.log("Set travel-no to checked");
          }
          
          // Trigger change event
          travelYes.checked ? travelYes.dispatchEvent(new Event('change', { bubbles: true })) : 
                            travelNo.dispatchEvent(new Event('change', { bubbles: true }));
          break;

        case "6": // Someone else can pick up
          const someoneElse = answer.toLowerCase();
          const someoneYes = document.getElementById("someone-yes");
          const someoneNo = document.getElementById("someone-no");
          
          // Clear previous selection
          someoneYes.checked = false;
          someoneNo.checked = false;
          
          // Set new selection
          if (someoneElse.includes("yes")) {
            someoneYes.checked = true;
            console.log("Set someone-yes to checked");
          } else if (someoneElse.includes("no")) {
            someoneNo.checked = true;
            console.log("Set someone-no to checked");
          }
          
          // Trigger change event
          someoneYes.checked ? someoneYes.dispatchEvent(new Event('change', { bubbles: true })) : 
                              someoneNo.dispatchEvent(new Event('change', { bubbles: true }));
          break;

        case "7": // Day preference
          const dayPref = answer.toLowerCase();
          const dayToday = document.getElementById("day-today");
          const dayAnother = document.getElementById("day-another");
          
          // Clear previous selection
          dayToday.checked = false;
          dayAnother.checked = false;
          
          // Set new selection
          if (dayPref.includes("today")) {
            dayToday.checked = true;
            console.log("Set day-today to checked");
          } else if (dayPref.includes("another")) {
            dayAnother.checked = true;
            console.log("Set day-another to checked");
          }
          
          // Trigger change event
          dayToday.checked ? dayToday.dispatchEvent(new Event('change', { bubbles: true })) : 
                            dayAnother.dispatchEvent(new Event('change', { bubbles: true }));
          break;

        case "8": // Specific day selection
          const dayOptions = answer.toLowerCase().split(',').map(day => day.trim());
          
          // Clear all previous day selections
          const dayCheckboxes = [
            "day-tomorrow", "day-monday", "day-tuesday", "day-wednesday",
            "day-thursday", "day-friday", "day-saturday", "day-sunday"
          ];
          
          // Uncheck all first
          dayCheckboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
              checkbox.checked = false;
            }
          });
          
          // Then check the ones mentioned in answer
          const dayKeywords = {
            "tomorrow": "day-tomorrow",
            "monday": "day-monday",
            "tuesday": "day-tuesday",
            "wednesday": "day-wednesday",
            "thursday": "day-thursday",
            "friday": "day-friday",
            "saturday": "day-saturday",
            "sunday": "day-sunday"
          };
          
          // Check matching days
          dayOptions.forEach(day => {
            for (const [keyword, id] of Object.entries(dayKeywords)) {
              if (day.includes(keyword)) {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                  checkbox.checked = true;
                  checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                  console.log(`Set ${id} to checked`);
                }
              }
            }
          });
          break;

        case "9": // Preferred pickup time
          const selectTime = document.getElementById("preferred-time");
          if (selectTime) {
            // Set the value directly first
            selectTime.value = "";
            
            // Try to find the best match for the time in the options
            for (let i = 0; i < selectTime.options.length; i++) {
              const optionText = selectTime.options[i].text.toLowerCase();
              if (answer.toLowerCase().includes(optionText) || 
                  optionText.includes(answer.toLowerCase())) {
                selectTime.selectedIndex = i;
                console.log(`Set preferred time to option ${i}: ${selectTime.options[i].text}`);
                break;
              }
            }
            
            // If no match found but answer contains time indicators, try best guess
            if (selectTime.selectedIndex === 0) {
              if (answer.toLowerCase().includes("morning") || 
                  answer.toLowerCase().includes("9") || 
                  answer.toLowerCase().includes("10") || 
                  answer.toLowerCase().includes("11")) {
                selectTime.selectedIndex = 1; // Morning option
              } else if (answer.toLowerCase().includes("afternoon") || 
                        answer.toLowerCase().includes("12") || 
                        answer.toLowerCase().includes("1") || 
                        answer.toLowerCase().includes("2") || 
                        answer.toLowerCase().includes("3")) {
                selectTime.selectedIndex = 2; // Afternoon option
              } else if (answer.toLowerCase().includes("evening") || 
                        answer.toLowerCase().includes("4") || 
                        answer.toLowerCase().includes("5") || 
                        answer.toLowerCase().includes("6")) {
                selectTime.selectedIndex = 3; // Evening option
              }
            }
            
            // Trigger change event
            selectTime.dispatchEvent(new Event('change', { bubbles: true }));
          }
          break;

        case "10": // Location
          const locationInput = document.getElementById("location");
          if (locationInput) {
            locationInput.value = answer;
            console.log(`Set location to: ${locationInput.value}`);
            
            // Trigger input and change events
            locationInput.dispatchEvent(new Event('input', { bubbles: true }));
            locationInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
          break;

        case "11": // Delivery time
          const deliveryTime = document.getElementById("delivery-time");
          if (deliveryTime) {
            // Set the value directly first
            deliveryTime.value = "";
            
            // Try to find the best match for the time in the options
            for (let i = 0; i < deliveryTime.options.length; i++) {
              const optionText = deliveryTime.options[i].text.toLowerCase();
              if (answer.toLowerCase().includes(optionText) || 
                  optionText.includes(answer.toLowerCase())) {
                deliveryTime.selectedIndex = i;
                console.log(`Set delivery time to option ${i}: ${deliveryTime.options[i].text}`);
                break;
              }
            }
            
            // If no match found but answer contains time indicators, try best guess
            if (deliveryTime.selectedIndex === 0) {
              if (answer.toLowerCase().includes("morning") || 
                  answer.toLowerCase().includes("9") || 
                  answer.toLowerCase().includes("10") || 
                  answer.toLowerCase().includes("11")) {
                deliveryTime.selectedIndex = 1; // Morning option
              } else if (answer.toLowerCase().includes("afternoon") || 
                        answer.toLowerCase().includes("12") || 
                        answer.toLowerCase().includes("1") || 
                        answer.toLowerCase().includes("2") || 
                        answer.toLowerCase().includes("3")) {
                deliveryTime.selectedIndex = 2; // Afternoon option
              } else if (answer.toLowerCase().includes("evening") || 
                        answer.toLowerCase().includes("4") || 
                        answer.toLowerCase().includes("5") || 
                        answer.toLowerCase().includes("6")) {
                deliveryTime.selectedIndex = 3; // Evening option
              }
            }
            
            // Trigger change event
            deliveryTime.dispatchEvent(new Event('change', { bubbles: true }));
          }
          break;

        case "12": // Comments
          const commentsInput = document.getElementById("comments");
          if (commentsInput) {
            commentsInput.value = answer;
            console.log(`Set comments to: ${commentsInput.value}`);
            
            // Trigger input and change events
            commentsInput.dispatchEvent(new Event('input', { bubbles: true }));
            commentsInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
          break;
        }
        
        // Mark current question as completed
        questionElement.classList.remove("active");
        questionElement.classList.add("completed");
        
        // Determine next question based on user's answers and logic
        let nextQuestionId = parseInt(questionId) + 1;
        
        // Apply skip logic
        if (questionId === "2" && document.getElementById("kitchen-no").checked) {
          // Skip food format question
          nextQuestionId = 4;
        } else if (questionId === "5" && document.getElementById("travel-yes").checked) {
          // Skip the someone else question
          nextQuestionId = 7;
        } else if (questionId === "6" && document.getElementById("someone-no").checked) {
          // Skip to delivery time question
          nextQuestionId = 11;
        } else if (questionId === "7" && document.getElementById("day-today").checked) {
          // Skip specific day selection
          nextQuestionId = 9;
        }
        
        // Activate next question
        const nextQuestionElement = document.querySelector(`.form-question[data-question-id="${nextQuestionId}"]`);
        if (nextQuestionElement) {
          nextQuestionElement.classList.add("active");
          setTimeout(scrollToActiveQuestion, 100); 
        }
        
        // Update progress bar
        updateFormProgress();
        if (nextQuestionId > 9) {
          // Mark the form as completed by setting nextQuestionId = null
          nextQuestionId = null;
        }
        return {
          success: true,
          questionId: questionId,
          answer: answer,
          formCompleted: !nextQuestionElement,
          nextQuestionId: nextQuestionElement ? nextQuestionId : null,
          skipLogicApplied: nextQuestionId > parseInt(questionId) + 1
        };
      } catch (e) {
        return { success: false, error: e.toString() };
      }
    },
    
    // Updated getNextFormQuestion function
    getNextFormQuestion: () => {
      const activeQuestion = document.querySelector('.form-question.active');
      
      if (!activeQuestion) {
        // If no question is active, activate the first one
        const firstQuestion = document.querySelector('.form-question');
        if (firstQuestion) {
          firstQuestion.classList.add('active');
          updateFormProgress();
          setTimeout(scrollToActiveQuestion, 100);
          return {
            success: true,
            questionId: firstQuestion.dataset.questionId,
            questionText: firstQuestion.querySelector('.form-label').innerText,
            exactQuestion: true
          };
        } else {
          return { success: false, error: "No questions found" };
        }
      }
      
      // Get the current active question information
      const currentQuestionId = activeQuestion.dataset.questionId;
      const questionText = activeQuestion.querySelector('.form-label').innerText;
      
      // Handle conditional text based on previous answers
      let modifiedText = questionText;
      
      // Modify question text based on previous answers
      if (currentQuestionId === "6" && document.getElementById("travel-no").checked) {
        modifiedText = "Can someone else pick up food for you?";
      }
      
      if (currentQuestionId === "7") {
        // Check if someone else is picking up
        const someoneElse = document.getElementById("someone-yes") && document.getElementById("someone-yes").checked;
        if (someoneElse) {
          modifiedText = "When would they like to go?";
        }
      }
      
      if (currentQuestionId === "8") {
        // Check if someone else is picking up
        const someoneElse = document.getElementById("someone-yes") && document.getElementById("someone-yes").checked;
        if (someoneElse) {
          modifiedText = "Which day would they prefer?";
        }
      }
      
      if (currentQuestionId === "9") {
        // Check if someone else is picking up
        const someoneElse = document.getElementById("someone-yes") && document.getElementById("someone-yes").checked;
        if (someoneElse) {
          modifiedText = "What time would they prefer?";
        }
      }
      
      return {
        success: true,
        questionId: currentQuestionId,
        questionText: modifiedText,
        originalText: questionText
      };
    },
    
    // Updated getFormStatus function
    getFormStatus: () => {
      const totalQuestions = document.querySelectorAll('.form-question').length;
      const visibleQuestions = document.querySelectorAll('.form-question:not([style*="display: none"])').length || totalQuestions;
      const completedQuestions = document.querySelectorAll('.form-question.completed').length;
      const currentQuestion = document.querySelector('.form-question.active');
      
      // Calculate progress based on visible questions only, accounting for skip logic
      const progress = Math.round((completedQuestions / visibleQuestions) * 100);

              // Check if form is completed
      const isCompleted = completedQuestions === visibleQuestions;
      
      if (isCompleted) {
        // Hide the form questions and controls
        const formQuestions = document.getElementById('formQuestions');
        const formControls = document.querySelector('.form-controls');
        const completionImage = document.querySelector('.completion-image');
        
        if (formQuestions) formQuestions.style.display = 'none';
        if (formControls) formControls.style.display = 'none';
        if (completionImage) completionImage.style.display = 'flex';
      }
      
      // For backward compatibility with existing code
      if (document.getElementById("name") && document.getElementById("kitchen-yes")) {
        // New food bank form is present
        // Gather form data to summarize user preferences
        const formData = {
          name: document.getElementById("name")?.value || "",
          hasKitchen: document.getElementById("kitchen-yes")?.checked || false,
          foodFormat: getSelectedCheckboxValues([
            "food-loose", "food-packaged", "food-prepared", "food-any"
          ]),
          dietaryPreferences: getSelectedCheckboxValues([
            "pref-latin", "pref-westafrican", "pref-eastafrican", "pref-southasian",
            "pref-eastasian", "pref-easteuropean", "pref-middleeastern", "pref-halal",
            "pref-kosher", "pref-vegetarian", "pref-vegan", "pref-none"
          ]),
          canTravel: document.getElementById("travel-yes")?.checked || false,
          someoneElseCanPickup: document.getElementById("someone-yes")?.checked || false,
          dayPreference: document.getElementById("day-today")?.checked ? "Today" : 
                        (document.getElementById("day-another")?.checked ? "Another day" : ""),
          specificDays: getSelectedCheckboxValues([
            "day-tomorrow", "day-monday", "day-tuesday", "day-wednesday",
            "day-thursday", "day-friday", "day-saturday", "day-sunday"
          ]),
          preferredTime: document.getElementById("preferred-time")?.value || "",
          location: document.getElementById("location")?.value || "",
          deliveryTime: document.getElementById("delivery-time")?.value || "",
          comments: document.getElementById("comments")?.value || ""
        };
        
        // Determine if home delivery is required
        const needsHomeDelivery = !formData.canTravel && !formData.someoneElseCanPickup;
        
        return {
          success: true,
          totalQuestions: totalQuestions,
          visibleQuestions: visibleQuestions,
          completedQuestions: completedQuestions,
          progress: progress,
          currentQuestionId: currentQuestion ? currentQuestion.dataset.questionId : null,
          isCompleted: completedQuestions === visibleQuestions,
          formData: formData,
          needsHomeDelivery: needsHomeDelivery,
          summary: generateFormSummary(formData)
        };
      } else {
        // Original form is present - backward compatibility
        return {
          success: true,
          totalQuestions: totalQuestions,
          completedQuestions: completedQuestions,
          progress: Math.round((completedQuestions / totalQuestions) * 100),
          currentQuestionId: currentQuestion ? currentQuestion.dataset.questionId : null,
          isCompleted: completedQuestions === totalQuestions
        };
      }
    }
  };

  function getUserLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Geolocation is not supported by this browser"));
        return;
      }
      
      const statusDiv = document.getElementById('locationStatus');
      if (statusDiv) {
        statusDiv.textContent = "Requesting your location...";
        statusDiv.style.display = "block";
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLon = position.coords.longitude;
          
          if (statusDiv) {
            statusDiv.textContent = `Location acquired: ${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;
            statusDiv.style.color = "green";
          }
          
          window.userLocation = {
            latitude: userLat,
            longitude: userLon
          };
          
          const locationInput = document.getElementById('userLocationInput');
          if (locationInput) {
            locationInput.value = `${userLat}, ${userLon}`;
          }
          
          resolve({ latitude: userLat, longitude: userLon });
        },
        (error) => {
          console.error("Error getting location:", error);
          
          if (statusDiv) {
            statusDiv.textContent = `Error getting location: ${error.message}`;
            statusDiv.style.color = "red";
          }
          
          reject(error);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    });
  }

  // Updated to handle both form formats
  function updateFormProgress() {
    // Check which form is present by looking for a distinctive element
    const isFoodBankForm = !!document.getElementById("kitchen-yes");
    
    if (isFoodBankForm) {
      // For food bank form with skip logic
      const visibleQuestions = document.querySelectorAll('.form-question:not([style*="display: none"])').length;
      const completedQuestions = document.querySelectorAll('.form-question.completed').length;
      const progress = Math.round((completedQuestions / visibleQuestions) * 100);
      
      const progressBar = document.getElementById('formProgress');
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
      }
    } else {
      // Original form logic
      const totalQuestions = document.querySelectorAll('.form-question').length;
      const completedQuestions = document.querySelectorAll('.form-question.completed').length;
      const progress = Math.round((completedQuestions / totalQuestions) * 100);
      
      const progressBar = document.getElementById('formProgress');
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
      }
    }
  }

  // Updated resetForm function to handle food bank form
  function resetForm() {
    // Check which form is present by looking for a distinctive element
    const isFoodBankForm = !!document.getElementById("kitchen-yes");
    
    if (isFoodBankForm) {
      // Reset all input fields
      document.getElementById('name').value = '';
      
      // Reset all radio buttons
      const radioButtons = document.querySelectorAll('input[type="radio"]');
      radioButtons.forEach(radio => {
        radio.checked = false;
      });
      
      // Reset all checkboxes
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Reset select elements
      if (document.getElementById('preferred-time')) {
        document.getElementById('preferred-time').selectedIndex = 0;
      }
      if (document.getElementById('delivery-time')) {
        document.getElementById('delivery-time').selectedIndex = 0;
      }
      
      // Reset textarea
      document.getElementById('comments').value = '';
    } else {
      // Original form reset
      document.getElementById('name').value = '';
      document.getElementById('age').value = '';
      document.getElementById('city').value = '';
      document.getElementById('transport-bus').checked = false;
      document.getElementById('transport-subway').checked = false;
      document.getElementById('transport-walk').checked = false;
      document.getElementById('comments').value = '';
    }
    
    // Reset question states (works for both forms)
    const questions = document.querySelectorAll('.form-question');
    questions.forEach((q, index) => {
      q.classList.remove('active', 'completed');
      if (index === 0) {
        q.classList.add('active');
      }
    });
     
    // Show form questions and controls, hide completion image
    const formQuestions = document.getElementById('formQuestions');
    const formControls = document.querySelector('.form-controls');
    const completionImage = document.querySelector('.completion-image');
    
    if (formQuestions) formQuestions.style.display = 'block';
    if (formControls) formControls.style.display = 'flex';
    if (completionImage) completionImage.style.display = 'none';
   
    setTimeout(scrollToActiveQuestion, 100);
    // Update progress bar
    updateFormProgress();
  }

  async function getLocationName(lat, lon) {
      const url = "https://nominatim.openstreetmap.org/reverse";
      const params = new URLSearchParams({
          format: "json",
          lat: lat,
          lon: lon,
          zoom: 14,
          addressdetails: 1
      });
      
      const headers = {
          "User-Agent": "TransitApp/1.0 (your-email@example.com)"
      };
      
      try {
          const response = await fetch(`${url}?${params}`, {
              headers: headers,
              timeout: 10000
          });
          
          const data = await response.json();
          return data.display_name || `(${lat}, ${lon})`;
      } catch (e) {
          return `(${lat}, ${lon})`;
      }
  }


  function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; 
      const dLat = toRadians(lat2 - lat1);
      const dLon = toRadians(lon2 - lon1);
      
      const a = 
          Math.pow(Math.sin(dLat / 2), 2) + 
          Math.cos(toRadians(lat1)) * 
          Math.cos(toRadians(lat2)) * 
          Math.pow(Math.sin(dLon / 2), 2);
      
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    
      return R * c;
  }

  function toRadians(degrees) {
      return degrees * (Math.PI / 180);
  }

  function extractStationCode(stopId) {
      if (stopId.startsWith("WMATAS:PF_")) {
          const remainder = stopId.substring("WMATAS:PF_".length);
          const parts = remainder.split("_");
          if (parts.length > 0) {
              return parts[0];
          }
      }
      return stopId;
  }

  async function station2Station(inputStr1, inputStr2) {
      const headers = { 'api_key': wmata_api_key };
      
      const fromStation = inputStr1;
      const toStation = inputStr2;
      
      const urlCost = `http://api.wmata.com/Rail.svc/json/jSrcStationToDstStationInfo?FromStationCode=${fromStation}&ToStationCode=${toStation}`;
      const responseCost = await fetch(urlCost, { headers });
      const costData = await responseCost.json();
      const costInfo = costData.StationToStationInfos[0];
      const fareInfo = costInfo.RailFare;
      
      const urlPrediction = `http://api.wmata.com/StationPrediction.svc/json/GetPrediction/${fromStation}`;
      const responsePrediction = await fetch(urlPrediction, { headers });
      const predictionData = await responsePrediction.json();
      const predictions = predictionData.Trains;
    
      const timeNow = new Date();
  
      const availableTrains = [];
      for (const train of predictions) {
          if (train.Min !== "ARR") {
              try {
                  const minutes = parseInt(train.Min);
                  if (minutes >= 5) {
                      availableTrains.push(train);
                  }
              } catch (e) {
                  continue;
              }
          }
      }
      
      const nextTrains = availableTrains.slice(0, 1);
      
      const finalTrains = [];
      for (const train of nextTrains) {
          const minutes = parseInt(train.Min);
          const predictedDeparture = new Date(timeNow);
          predictedDeparture.setMinutes(timeNow.getMinutes() + minutes);
          
          const dayOfWeek = new Intl.DateTimeFormat('en-US', { weekday: 'long', timeZone: 'America/New_York' }).format(predictedDeparture);
          const hour = predictedDeparture.getHours();
          
          let finalCost;
          if (dayOfWeek === "Saturday" || dayOfWeek === "Sunday") {
              finalCost = fareInfo.OffPeakTime;
          } else {
              if ((10 <= hour && hour <= 15) || hour >= 19) {
                  finalCost = fareInfo.OffPeakTime;
              } else {
                  finalCost = fareInfo.PeakTime;
              }
          }
          
          const trainInfo = {
              Car: train.Car,
              Destination: train.Destination,
              Min: train.Min,
              PredictedDepartureTime: predictedDeparture.toLocaleString('en-US', { 
                  timeZone: 'America/New_York',
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
                  hour12: false
              }),
              FinalCost: finalCost
          };
          
          finalTrains.push(trainInfo);
      }
      
      return finalTrains.length > 0 ? finalTrains[0].FinalCost : "$2.00";
  }



  async function createItinerarySummary(itinerary) {
    
      const legs = itinerary.legs || [];
      const summarySentences = [];
      let totalSubwayCost = 0.0;

      for (const leg of legs) {
          
          const startTime = new Date(leg.startTime);
          const startTimeStr = startTime.toLocaleTimeString('en-US', { 
              hour: '2-digit', 
              minute: '2-digit', 
              hour12: false,
              timeZone: 'America/New_York'
          });

          const mode = leg.mode || "travel";

          const fromLocation = leg.from || {};
          let fromName = (fromLocation.name || "").trim();
          if (!fromName) {
              const fromLat = fromLocation.lat;
              const fromLon = fromLocation.lon;
              if (fromLat !== undefined && fromLon !== undefined) {
                  fromName = await getLocationName(fromLat, fromLon);
              } else {
                  fromName = "Unknown location";
              }
          }

          const toLocation = leg.to || {};
          let toName = (toLocation.name || "").trim();
          if (!toName) {
              const toLat = toLocation.lat;
              const toLon = toLocation.lon;
              if (toLat !== undefined && toLon !== undefined) {
                  toName = await getLocationName(toLat, toLon);
              } else {
                  toName = "Unknown location";
              }
          }

          let costEstimate = "$5-$10";
          let sentence = "";

          if (mode.toUpperCase() === "WALK") {
              sentence = `At ${startTimeStr}, walk from ${fromName} to ${toName}.`;
          } else if (mode.toUpperCase() === "BUS") {
              const route = (leg.route || "").trim();
              if (route) {
                  sentence = `At ${startTimeStr}, board bus ${route} from ${fromName} to ${toName}.`;
              } else {
                  sentence = `At ${startTimeStr}, board the bus from ${fromName} to ${toName}.`;
              }
          } else if (mode.toUpperCase() === "SUBWAY") {
              const route = (leg.route || "").trim();
              const fromStationId = (fromLocation.stopId || "").trim();
              const toStationId = (toLocation.stopId || "").trim();
              const fromStationCode = fromStationId ? extractStationCode(fromStationId) : "";
              const toStationCode = toStationId ? extractStationCode(toStationId) : "";

              console.log("From station code", fromStationCode);
              console.log("To station code", toStationCode);

              let currentCost = 0.0;
              if (fromStationCode && toStationCode) {
                  try {
                      costEstimate = station2Station(fromStationCode, toStationCode);
                      currentCost = parseFloat(costEstimate.replace('$', ''));
                  } catch (e) {
                      costEstimate = "$5-$10";
                      currentCost = 0.0;
                  }
              } else {
                  currentCost = 0.0;
              }
              totalSubwayCost += currentCost;

              if (route) {
                  sentence = `At ${startTimeStr}, take the subway ${route} from ${fromName} to ${toName}. Estimated cost: ${costEstimate}`;
              } else {
                  sentence = `At ${startTimeStr}, take the subway from ${fromName} to ${toName}. Estimated cost: ${costEstimate}`;
              }
          } else {
              sentence = `At ${startTimeStr}, travel by ${mode} from ${fromName} to ${toName}.`;
          }

          summarySentences.push(sentence);
      }

      let finalSummary = summarySentences.join(" ");
      finalSummary += ` Total estimated subway cost: $${totalSubwayCost.toFixed(2)}.`;
      return finalSummary;
  }

//     async function planTransit(inputStr) {
//     try {
//         const parts = inputStr.split(",").map(x => x.trim());
//         if (parts.length !== 4) {
//             return JSON.stringify([{
//                 error: "Input should be in the format 'from_lat, from_lon, to_lat, to_lon'."
//             }]);
//         }
      
//         const [fromLat, fromLon, toLat, toLon] = parts;
      
//         const departureTime = new Date();
//         departureTime.setMinutes(departureTime.getMinutes() + 10);
      
//         const dateStr = departureTime.toISOString().split('T')[0];
//         const timeStr = departureTime.toLocaleTimeString('en-US', { 
//             hour: '2-digit', 
//             minute: '2-digit', 
//             hour12: false 
//         });
      
//         const params = new URLSearchParams({
//             fromPlace: `${fromLat},${fromLon}`,
//             toPlace: `${toLat},${toLon}`,
//             numItineraries: 1,
//             date: dateStr,
//             time: timeStr,
//             mode: "TRANSIT,WALK",
//             arriveBy: "false"
//         });
      
//         console.log(`Making transit request to proxy: /proxy-transit?${params}`);
      
//         try {
          
//             const response = await fetch(` http://localhost:4000/transitPlan?${params}`);
          
//             if (!response.ok) {
//                 const errorText = await response.text();
//                 throw new Error(`HTTP error ${response.status}: ${errorText}`);
//             }
          
//             const data = await response.json();
          
//             if (!data.plan || !data.plan.itineraries || data.plan.itineraries.length === 0) {
//                 return JSON.stringify([{
//                     "start_time": departureTime.toLocaleString('en-US', { timeZone: 'America/New_York' }),
//                     "message": "No transit routes found. Try walking or using another transportation method."
//                 }]);
//             }
          
//             const itinerary = data.plan.itineraries[0];
//             const totalDurationMinutes = itinerary.duration / 60;
//             const itinerarySummary = await createItinerarySummary(itinerary);
          
//             return JSON.stringify([{
//                 "start_from_your_place_at": departureTime.toLocaleString('en-US', { timeZone: 'America/New_York' }),
//                 "total_duration_minutes": totalDurationMinutes,
//                 "itinerary": itinerarySummary
//             }]);
//         } catch (e) {
//             console.error("Transit planning error:", e);
          
//             return JSON.stringify([{
//                 "error": e.toString(),
//                 "fallback_message": "Transit planning service couldn't find a route. The food bank location is available on a map service using the coordinates."
//             }]);
//         }
//     } catch (e) {
//         return JSON.stringify([{
//             "error": `Error parsing transit input: ${e}`
//         }]);
//     }
// }

async function planTransit(inputStr) {
  try {
      const parts = inputStr.split(",").map(x => x.trim());
      if (parts.length !== 4) {
          return JSON.stringify([{
              error: "Input should be in the format 'from_lat, from_lon, to_lat, to_lon'."
          }]);
      }
      
      const [fromLat, fromLon, toLat, toLon] = parts;
      
      // Set fixed departure time to April 15, 2025, 4:30 PM EST
      const departureTime = new Date('2025-04-15T16:30:00-04:00');
      
      // Format date and time for the API
      const dateStr = departureTime.toISOString().split('T')[0]; // "2025-04-15"
      const timeStr = "16:30"; // 24-hour format for 4:30 PM
      
      const params = new URLSearchParams({
          fromPlace: `${fromLat},${fromLon}`,
          toPlace: `${toLat},${toLon}`,
          numItineraries: 1,
          date: dateStr,
          time: timeStr,
          mode: "TRANSIT,WALK",
          arriveBy: "false"
      });
      
      console.log(`Making transit request to proxy: /proxy-transit?${params}`);
      
      try {
          const response = await fetch(` http://localhost:4000/transitPlan?${params}`);
          
          if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP error ${response.status}: ${errorText}`);
          }
          
          const data = await response.json();
          
          if (!data.plan || !data.plan.itineraries || data.plan.itineraries.length === 0) {
              return JSON.stringify([{
                  "start_time": departureTime.toLocaleString('en-US', { 
                      timeZone: 'America/New_York',
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit',
                      hour: '2-digit',
                      minute: '2-digit',
                      hour12: true
                  }),
                  "message": "No transit routes found. Try walking or using another transportation method."
              }]);
          }
          
          const itinerary = data.plan.itineraries[0];
          const totalDurationMinutes = itinerary.duration / 60;
          const itinerarySummary = await createItinerarySummary(itinerary);
          
          return JSON.stringify([{
              "start_from_your_place_at": "April 15, 2025, 4:30 PM EDT",
              "total_duration_minutes": totalDurationMinutes,
              "itinerary": itinerarySummary
          }]);
      } catch (e) {
          console.error("Transit planning error:", e);
          
          return JSON.stringify([{
              "error": e.toString(),
              "fallback_message": "Transit planning service couldn't find a route. The food bank location is available on a map service using the coordinates."
          }]);
      }
  } catch (e) {
      return JSON.stringify([{
          "error": `Error parsing transit input: ${e}`
      }]);
  }
}
// Function to auto-scroll to the active question
    function scrollToActiveQuestion() {
      const activeQuestion = document.querySelector('.form-question.active');
      const formContainer = document.querySelector('.form-container');
      
      if (activeQuestion && formContainer) {
        // Calculate the position to scroll to (element's position relative to the container)
        const containerRect = formContainer.getBoundingClientRect();
        const questionRect = activeQuestion.getBoundingClientRect();
        const relativePosition = questionRect.top - containerRect.top;
        
        // Scroll with some padding at the top
        const padding = 20;
        formContainer.scrollTo({
          top: formContainer.scrollTop + relativePosition - padding,
          behavior: 'smooth' // Add smooth scrolling effect
        });
      }
    }
  // function findNearestFoodBankVoice(inputStr) {
  //     try {
  //         const parts = inputStr.split(",").map(x => x.trim());
  //         if (parts.length !== 2) {
  //             return "Error: Input should be in the format 'lat, lon'.";
  //         }
  //         const userLat = parseFloat(parts[0]);
  //         const userLon = parseFloat(parts[1]);

  //         let nearest = null;
  //         let minDist = Infinity;
          
  //         for (const fb of foodBanks) {
  //             const dist = haversineDistance(userLat, userLon, fb.lat, fb.lon);
  //             if (dist < minDist) {
  //                 minDist = dist;
  //                 nearest = fb;
  //             }
  //         }
          
  //         return nearest;
  //     } catch (e) {
  //         return `Error parsing coordinates: ${e}`;
  //     }
  // }

  function findNearestFoodBankVoice(inputStr) {
   try {
    // const parts = inputStr.split(",").map(x => x.trim());
    // if (parts.length !== 2) {
    //   return "Error: Input should be in the format 'lat, lon'.";
    // }
    // const userLat = parseFloat(parts[0]);
    // const userLon = parseFloat(parts[1]);
  
    // const formStatus = fns.getFormStatus();
    
    // const normalizedFormData = normalizeFormData(formStatus.formData || {});
    // console.log("Normalized form data:", normalizedFormData);
    

    // let filteredBanks = globalFoodBanks.length > 0 ? globalFoodBanks : defaultFoodBanks;
    
    // if (normalizedFormData.foodFormat && normalizedFormData.foodFormat.length > 0) {
    //   const formatBanks = filteredBanks.filter(fb => {
    //     return normalizedFormData.foodFormat.some(format => {
    //       // Check if the specific format column is "Yes"
    //       const formatKey = format.replace(/\s+/g, ' ').trim();
    //       return fb[formatKey] === "Yes";
    //     });
    //   });
  
    //   if (formatBanks.length > 0) {
    //     filteredBanks = formatBanks;
    //     console.log(`Filtered to ${filteredBanks.length} banks by food format`);
    //   }
    // }
    
    // if (normalizedFormData.dietaryPreferences && normalizedFormData.dietaryPreferences.length > 0) {
    //   const dietaryBanks = filteredBanks.filter(fb => {
    //     return normalizedFormData.dietaryPreferences.some(pref => {
    //       const prefKey = pref.replace(/\//g, '\\/').trim();
    //       return fb[prefKey] === "Yes";
    //     });
    //   });
      
    //   if (dietaryBanks.length > 0) {
    //     filteredBanks = dietaryBanks;
    //     console.log(`Filtered to ${filteredBanks.length} banks by dietary preferences`);
    //   }
    // }
   
    // const dayPreference = normalizedFormData.dayPreference || "Today";

    // let targetDay;
    // if (dayPreference === "Today") {
    //   const today = new Date();
    //   const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    //   targetDay = daysOfWeek[today.getDay()];
    // } else if (dayPreference === "Another day" && normalizedFormData.specificDays && normalizedFormData.specificDays.length > 0) {
      
    //   targetDay = normalizedFormData.specificDays[0];
    // } else {
     
    //   const today = new Date();
    //   const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    //   targetDay = daysOfWeek[today.getDay()];
    // }
 
    // const dayFilteredBanks = filteredBanks.filter(fb => {
    //   const dayOfWeek = fb["Day of Week"] || "";
    //   const frequency = fb["Frequency"] || "";
    //   return dayOfWeek === targetDay || frequency.includes("Every week");
    // });
 
    // if (dayFilteredBanks.length > 0) {
    //   filteredBanks = dayFilteredBanks;
    //   console.log(`Filtered to ${filteredBanks.length} banks by day: ${targetDay}`);
    // }
    

    // const needsDelivery = normalizedFormData.canTravel === false && 
    //                       normalizedFormData.someoneElseCanPickup === false;
    
    // if (needsDelivery) {
    //   const deliveryBanks = filteredBanks.filter(fb => {
    //     const distributionModels = fb["Distribution Models"] || "";
    //     return distributionModels.toLowerCase().includes("delivery");
    //   });
    
    //   if (deliveryBanks.length > 0) {
    //     filteredBanks = deliveryBanks;
    //     console.log(`Filtered to ${filteredBanks.length} banks that offer delivery`);
    //   }
    // }

    // if (filteredBanks.length === 0) {
    //   console.log("No food banks match the filters. Using all available food banks.");
    //   filteredBanks = globalFoodBanks.length > 0 ? globalFoodBanks : defaultFoodBanks;
    // }
 
    let nearest = null;
    let minDist = Infinity;
    filteredBanks = [{"Agency ID":"14545-PART-01","Agency Name":"Mt. Rainier Seventh Day Adventist Spanish Church : Mount Rainier Seventh Day Adventist Spanish Church","Agency Region":"MD","County\/Ward":"MD Prince George's County","Shipping Address":"Attn: Mount Rainier Seventh Day Adventist Spanish Chuch 6012 Ager Road Hyattsville MD 20782","Cleaned Address":"6012 Ager Road Hyattsville MD 20782","Latitude":38.9542534204,"Longitude":-76.9652870101,"Phone":"(240) 346-9272","Day of Week":"Wednesday","Frequency":"2nd of the Month","Starting Time":"19:00:00","Ending Time":"21:00:00","By Appointment Only":"Yes","Food Pantry Requirements":"ID","Food Format":"Loose groceries","Loose groceries":"Yes","Pre-bagged or boxed groceries":"No","Prepared meals":"No","Distribution Models":"Drive thru,Home Delivery,Walk up","Cultural Populations Served":"East African,Eastern European,Latin American,West African","Latin American":"Yes","West African":"Yes","East African":"Yes","Central\/South Asian":"No","East Asian":"No","Eastern European":"Yes","Middle Eastern\/North African":"No","Last SO Create Date":"2024-12-02","Date of Last Verification":"2024-10-09","Additional Note on Hours of Operations":null}]
    for (const fb of filteredBanks) {
      const fbLat = parseFloat(fb["Latitude"]);
      const fbLon = parseFloat(fb["Longitude"]);
      
      if (isNaN(fbLat) || isNaN(fbLon)) {
        continue; // Skip invalid coordinates
      }
      
      const dist = haversineDistance(userLat, userLon, fbLat, fbLon);
      if (dist < minDist) {
        minDist = dist;
        nearest = {
          name: fb["Agency Name"],
          lat: fbLat,
          lon: fbLon,
          foodFormat: fb["Food Format"],
          address: fb["Cleaned Address"],
          phone: fb["Phone"],
          dayOfWeek: fb["Day of Week"],
          hours: `${fb["Starting Time"]} - ${fb["Ending Time"]}`,
          frequency: fb["Frequency"],
          offersDelivery: (fb["Distribution Models"] || "").toLowerCase().includes("delivery"),
          region: fb["Agency Region"],
          requirements: fb["Food Pantry Requirements"] || "None specified",
          appointment: fb["By Appointment Only"] === "Yes"
        };
      }
    }
    
    console.log("Found nearest food bank:", nearest);
    return nearest;
  } catch (e) {
    console.error("Error in findNearestFoodBankVoice:", e);
    return `Error processing food bank data: ${e}`;
  }
}




  const foodBanks = [
      // {"name": "Food Bank A - Target", "lat": 38.998959, "lon": -76.906453},
      {"name": "Food Bank B - Lidl", "lat": 38.996214, "lon": -76.931543},
      {"name": "Food Bank C - Capitol Hill", "lat": 38.889263, "lon": -76.991530},
      {"name": "Food Bank D - Trader Joe's", "lat": 38.978089, "lon": -76.938279}
  ];

  const transit_app_api_key = "d2075a8b39fe7d775cf2a672682dfa41ed554d531095786cfe030853c50e8675";

  const wmata_api_key = "59390b5927944b7ea2fd0680bb36ec33";



  function configureData(dc) {
    console.log("Configuring data channel for tool calling");
    const event = {
      type: 'session.update',
      session: {
        modalities: ['text', 'audio'],
        tools: [
          {
            type: 'function',
            name: 'changeBackgroundColor',
            description: 'Changes the background color of the page',
            parameters: {
              type: 'object',
              properties: {
                color: { type: 'string', description: 'A hex value of the color' },
              },
            },
          },
          {
            type: 'function',
            name: 'changeTextColor',
            description: 'Changes the text color of the page',
            parameters: {
              type: 'object',
              properties: {
                color: { type: 'string', description: 'A hex value of the color' },
              },
            },
          },
          {
            type: 'function',
            name: 'getPageHTML',
            description: 'Gets the HTML for the current page',
          },
          {
            type: 'function',
            name: 'voiceTransit',
            description: 'Given the current location of the user, finds the nearest food bank and provides transit options',
            parameters: {
              type: 'object',
              properties: {
                location: { 
                  type: 'string', 
                  description: 'User location in format "latitude,longitude" (e.g. "38.897957,-77.036560")' 
                }
              },
            }
          },
          // New form handling tools
          {
            type: 'function',
            name: 'getNextFormQuestion',
            description: 'Gets the EXACT next question to ask in the food bank form. ALWAYS call this before asking any question to ensure you ask the correct question as shown in the form. Do not make up your own questions.',
          },
          {
            type: 'function',
            name: 'processFormInput',
            description: 'Process user input for a food bank form question. Call this after receiving user\'s answer to store their response. ALWAYS process current input before going to next question',
            parameters: {
              type: 'object',
              properties: {
                questionId: { 
                  type: 'string', 
                  description: 'The ID of the question being answered' 
                },
                answer: {
                  type: 'string',
                  description: 'The user\'s answer to the question'
                }
              },
              required: ['questionId', 'answer']
            }
          },
          {
            type: 'function',
            name: 'getFormStatus',
            description: 'Gets the current status of the form completion',
          }
        ],
      },
    };
    dc.send(JSON.stringify(event));
    console.log("Tool configuration sent:", event);
  }


  async function init() {
    try {

      // try {
      //   // Load food bank data first
      //   globalFoodBanks = await loadFoodBankData();
      //   console.log(`Loaded ${globalFoodBanks.length} food banks successfully`);
        
      //   // Rest of your initialization code...
      // } catch (error) {
      //   console.error("Error initializing:", error);
      // }
      
      try {
        
        await getUserLocation();
        console.log("User location acquired:", window.userLocation);
      } catch (locationError) {
        console.error("Could not get user location:", locationError);
        // Continue with the rest of initialization even if location fails
      }
      
      const tokenResponse = await fetch("/session");
      const tokenData = await tokenResponse.json();
      const EPHEMERAL_KEY = tokenData.client_secret.value;
      console.log("Ephemeral key received:", EPHEMERAL_KEY);

      
      const pc = new RTCPeerConnection();

     
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);
      pc.ontrack = e => {
        if (e.streams && e.streams[0]) {
          audioEl.srcObject = e.streams[0];
          startBackendVisualizer(e.streams[0]);
        }
      };

      
      const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      pc.addTrack(micStream.getTracks()[0]);
      startLocalVisualizer(micStream);

      
      const dc = pc.createDataChannel("oai-events");

      dc.addEventListener("open", () => {
        console.log("Data channel open");
        configureData(dc);
      });

    
      dc.addEventListener("message", async (e) => {
        console.log("Data Channel message received:", e.data);
        let msg;
        try {msg = JSON.parse(e.data);
        } catch (err) {
          console.error("Error parsing data channel message:", err);
          return;
        }
      
        if (msg.type === 'response.function_call_arguments.done') {
          const fn = fns[msg.name];
          if (fn !== undefined) {
            console.log(`Calling local function ${msg.name} with arguments: ${msg.arguments}`);
            const args = JSON.parse(msg.arguments);
            try {
              const result = await fn(args);
              console.log('Function result:', result);
             
              dc.send(JSON.stringify({
                type: 'conversation.item.create',
                item: {
                  type: 'function_call_output',
                  call_id: msg.call_id, 
                  output: JSON.stringify(result)
                }
              }));

              dc.send(JSON.stringify({ type: "response.create" }));
            } catch (error) {
              console.error("Error calling function:", error);
            }
          } else {
            console.warn(`No function defined for name: ${msg.name}`);
          }
        }
      });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      console.log("SDP offer created and set as local description.");

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";
      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        body: offer.sdp,
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp"
        },
      });

      const answerSdp = await sdpResponse.text();
      const answer = {
        type: "answer",
        sdp: answerSdp,
      };
      await pc.setRemoteDescription(answer);
      console.log("SDP answer received and set as remote description. WebRTC connection established.");
    } catch (error) {
      console.error("Error initializing WebRTC connection:", error);
    }
  }


  function startLocalVisualizer(stream) {
    const localCanvas = document.getElementById('localVisualizer');
    const localCtx = localCanvas.getContext('2d');
    localCanvas.width = localCanvas.offsetWidth;
    localCanvas.height = localCanvas.offsetHeight;

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteTimeDomainData(dataArray);
      localCtx.fillStyle = '#f5f5f5';
      localCtx.fillRect(0, 0, localCanvas.width, localCanvas.height);
      localCtx.lineWidth = 2;
      localCtx.strokeStyle = '#007bff';
      localCtx.beginPath();
      const sliceWidth = localCanvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * localCanvas.height / 2;
        if (i === 0) {
          localCtx.moveTo(x, y);
        } else {
          localCtx.lineTo(x, y);
        }
        x += sliceWidth;
      }
      localCtx.lineTo(localCanvas.width, localCanvas.height / 2);
      localCtx.stroke();
    }
    draw();
  }

  function startBackendVisualizer(remoteStream) {
    const backendCanvas = document.getElementById('backendVisualizer');
    const backendCtx = backendCanvas.getContext('2d');
    backendCanvas.width = backendCanvas.offsetWidth;
    backendCanvas.height = backendCanvas.offsetHeight;

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    const source = audioContext.createMediaStreamSource(remoteStream);
    source.connect(analyser);

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteTimeDomainData(dataArray);
      backendCtx.fillStyle = '#f5f5f5';
      backendCtx.fillRect(0, 0, backendCanvas.width, backendCanvas.height);
      backendCtx.lineWidth = 2;
      backendCtx.strokeStyle = '#ff0000';
      backendCtx.beginPath();
      const sliceWidth = backendCanvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * backendCanvas.height / 2;
        if (i === 0) {
          backendCtx.moveTo(x, y);
        } else {
          backendCtx.lineTo(x, y);
        }
        x += sliceWidth;
      }
      backendCtx.lineTo(backendCanvas.width, backendCanvas.height / 2);
      backendCtx.stroke();
    }
    draw();
  }

  // Add event listeners for form controls
  document.addEventListener('DOMContentLoaded', function() {
    const startVoiceFormBtn = document.getElementById('startVoiceForm');
    const resetFormBtn = document.getElementById('resetForm');
    
    if (startVoiceFormBtn) {
      startVoiceFormBtn.addEventListener('click', function() {
        // Reset and start the form
        resetForm();
        
        const startMessage = {
          type: 'conversation.item.create',
          item: {
            type: 'text',
            text: "Let's start filling out the form. I'll ask you questions one by one."
          }
        };
        
        console.log("Form started by user");
      });
    }
    
    if (resetFormBtn) {
      resetFormBtn.addEventListener('click', function() {
        resetForm();
      });
    }
  });

  init().catch(err => console.error("Error initializing connection:", err));
</script>


